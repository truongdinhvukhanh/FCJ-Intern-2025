# Worklog - Ngày 16/07/2025

## 📅 Thông tin cơ bản

- **Ngày**: 16/07/2025
- **Thứ**: Thứ Tư
- **Tuần thực tập**: Tuần thứ 10
- **Thời gian làm việc**: 13:00 - 17:00
- **Mood**: 😊 Rất vui vì đã giải quyết được vấn đề truy cập OpenSearch Dashboard sau nhiều nỗ lực.

## 🎯 Mục tiêu ngày hôm nay

- [x]  Mục tiêu 1: Tìm cách fix vấn đề về quyền khi kết nối đến OpenSearch Dashboard
- [ ]  Mục tiêu 2: Thiết lập Kinesis Firehose Stream với Destination là OpenSearch và backup vào S3 Bucket (sẽ thực hiện sau khi OpenSearch Dashboard truy cập được)

## 💼 Công việc đã thực hiện

### 1. Fix vấn đề về quyền khi kết nối đến OpenSearch Dashboard ⏱️ 13:00 - 17:00

- **Mô tả**:
    - Rà soát lại IAM Role của EC2 Bastion và OpenSearch Domain Policy một cách cẩn thận.
    - Tạm thời đặt OpenSearch Domain Policy là "Allow all" để loại trừ hoàn toàn các vấn đề về quyền ở cấp domain.
    - Truy cập vào OpenSearch Dashboard (lúc này đã thành công do policy "Allow all").
    - Tiến hành mapping quyền cho IAM Role của Bastion Host trong Security configuration của OpenSearch Dashboard (ví dụ: tạo role `analyst` trong OpenSearch và gán IAM role của Bastion vào đó).
    - Siết lại quyền trong OpenSearch Domain Policy để chỉ cho phép IAM Role của Bastion truy cập vào các action cần thiết
- **Kết quả**: Bastion Host đã truy cập thành công vào OpenSearch Dashboard với quyền được cấp thông qua IAM Role và mapping trong OpenSearch.
- **Tools/Tech**:
    - Amazon OpenSearch Service
    - Amazon EC2
    - Amazon Q
- **Links**: [GitHub commits, documentation, screenshots]

## 📚 Kiến thức học được

### 🔧 Technical Skills

- **AWS Services**: Nắm vững hơn về cơ chế xác thực và ủy quyền trong Amazon OpenSearch Service, đặc biệt là sự kết hợp giữa IAM policies (tại cấp dịch vụ), OpenSearch Domain Access Policies (tại cấp domain) và Fine-grained access control (bên trong Dashboard, mapping IAM role với các vai trò của OpenSearch như `all_access`, `read_only`).
- **DevOps**: Cải thiện kỹ năng troubleshooting các vấn đề phức tạp liên quan đến bảo mật và quyền truy cập trong môi trường cloud. Hiểu rõ quy trình kiểm tra và siết chặt quyền sau khi xác minh truy cập.
- **Architecture**: Hiểu sâu hơn về các lớp bảo mật khi truy cập một dịch vụ trong VPC thông qua Bastion Host và cách các lớp đó tương tác để đảm bảo an toàn.

### 💡 Concepts & Theory

- **New Concepts**:
    - **Fine-grained access control (FGAC)** trong OpenSearch Service: Cho phép quản lý quyền truy cập ở cấp độ Index, Document, Field, và thậm chí là trên Dashboard.
    - **Internal Users/Roles** trong OpenSearch và cách chúng được **mapped** với IAM users/roles.
    - Quy trình **debug quyền truy cập** bằng cách nới lỏng tạm thời để xác định nguyên nhân gốc rễ, sau đó siết chặt lại.
- **Best Practices**:
    - **Luôn bắt đầu với quyền hạn thấp nhất** và nâng dần lên. (Bài học từ việc phải "Allow all" rồi siết lại).
    - **Phân tách trách nhiệm** rõ ràng giữa IAM (cấp quyền AWS) và Fine-grained access control (cấp quyền trong OpenSearch).
    - Sử dụng **Bastion Host** kết hợp với **SSH Tunneling** là một phương pháp an toàn để truy cập các tài nguyên trong VPC.
- **Industry Knowledge**: Quy trình chuẩn trong việc **xử lý sự cố bảo mật**: xác định vấn đề, cô lập nguyên nhân, áp dụng giải pháp tạm thời (nếu cần), kiểm tra, và cuối cùng là áp dụng giải pháp bền vững.

### 🤝 Soft Skills

- **Problem Solving**: Đã kiên trì và thành công trong việc giải quyết một vấn đề phức tạp, đòi hỏi sự phân tích sâu sắc và thử nghiệm nhiều phương án.
- **Learning**: Tích cực tìm kiếm thông tin từ nhiều nguồn và tổng hợp kiến thức để đưa ra giải pháp hiệu quả.
- **Time Management**: Mặc dù mất khá nhiều thời gian, nhưng đã tập trung và giải quyết triệt để vấn đề, giúp mở khóa các công việc tiếp theo.

## 🚧 Khó khăn và giải pháp

### Vấn đề 1: **Kết nối đến OpenSearch Dashboard bị từ chối**

- **Mô tả**: Ban đầu, dù đã cấu hình IAM Role và Security Group, vẫn không thể truy cập OpenSearch Dashboard. Lỗi "Denied" liên tục xuất hiện.
- **Impact**: Ngăn cản việc tiến hành các bước tiếp theo như thiết lập Kinesis Firehose và kiểm tra dữ liệu.
- **Root Cause**: Nguyên nhân chính là do thiếu cấu hình **Fine-grained access control** bên trong OpenSearch Dashboard để **mapping IAM Role của Bastion Host với một vai trò có quyền truy cập Dashboard** (ví dụ: `all_access` hoặc một vai trò tùy chỉnh). Chỉ cấp quyền qua IAM Policy và Domain Policy là chưa đủ nếu không có mapping này.
- **Solution**:
    1. **Đặt OpenSearch Domain Policy thành "Allow all"** tạm thời để truy cập Dashboard.
    2. **Đăng nhập vào OpenSearch Dashboard** bằng master user (khi tạo domain) hoặc bằng IAM Role có quyền admin nếu đã cấu hình.
    3. Điều hướng đến **Security** -> **Roles** và **Role mappings**.
    4. **Tạo một role mới** (hoặc sử dụng `all_access`) và **mapping IAM Role của Bastion Host** vào role đó.
    5. **Siết chặt lại OpenSearch Domain Policy** để chỉ cho phép các quyền cần thiết (`es:ESHttpGet`, `es:ESHttpPost`, v.v.) từ IAM Role của Bastion.
- **Result**: Đã truy cập thành công vào OpenSearch Dashboard thông qua Bastion Host, giải quyết được rào cản lớn nhất của ngày.
- **Lesson**: Hiểu rõ các lớp bảo mật trong AWS là cực kỳ quan trọng, đặc biệt khi các dịch vụ có cơ chế xác thực riêng biệt ngoài IAM (như Fine-grained access control của OpenSearch). Đôi khi, việc "nới lỏng" tạm thời có kiểm soát có thể giúp xác định nguyên nhân gốc rễ nhanh hơn.

## 💭 Reflection & Insights

### What went well today?

- **Hoàn thành mục tiêu quan trọng**: Đã thành công trong việc giải quyết vấn đề truy cập OpenSearch Dashboard, mở khóa cho các bước công việc tiếp theo.
- **Học hỏi sâu sắc**: Có được kiến thức thực tế rất giá trị về bảo mật OpenSearch và kỹ thuật debugging đa lớp.
- **Kiên trì và không bỏ cuộc**: Dù gặp khó khăn ngày hôm qua, đã tiếp tục tìm hiểu và cuối cùng đã tìm ra giải pháp.

### What could be improved?

- **Nghiên cứu trước kỹ hơn**: Lẽ ra nên tìm hiểu sâu hơn về cơ chế **Fine-grained access control** của OpenSearch ngay từ đầu để tránh mất thời gian debugging.
- **Tận dụng Amazon Q hiệu quả hơn**: Có thể hỏi Amazon Q chi tiết hơn về các trường hợp xác thực phức tạp để có hướng đi nhanh hơn.

### Key Insights

- **Multi-layered security is key**: Bảo mật trên AWS là sự kết hợp của nhiều lớp (Network, IAM, Resource Policies, và cả cơ chế xác thực nội bộ của từng dịch vụ). Hiểu rõ từng lớp là điều cần thiết.
- **Debugging là một kỹ năng cần thiết**: Khả năng phân tích vấn đề, loại trừ nguyên nhân, và tìm kiếm giải pháp là kỹ năng vô giá đối với một kỹ sư đám mây.
- **Quan trọng là xác định đúng "Root Cause"**: Khi đã biết nguyên nhân gốc rễ (thiếu mapping quyền trong FGAC), giải pháp trở nên rõ ràng.

### Questions & Curiosities

- Có cách nào để tự động hóa việc mapping quyền trong OpenSearch FGAC bằng IaC (ví dụ: Terraform) thay vì thao tác thủ công qua Dashboard không?
- Các trường hợp sử dụng **Amazon Cognito** để xác thực OpenSearch Dashboard khác với việc sử dụng IAM như thế nào, và khi nào nên dùng cái nào?
- Liệu việc **siết chặt quyền** OpenSearch Domain Policy có ảnh hưởng đến các dịch vụ AWS khác (như Kinesis Firehose) khi chúng cố gắng gửi dữ liệu đến OpenSearch không?

## 📋 Kế hoạch ngày mai

### Priority Tasks

- [ ]  **High**: Thiết lập Kinesis Firehose Stream với Destination là OpenSearch và backup vào S3 Bucket
- [ ]  **Medium**: Kiểm tra xem dữ liệu có đến đích như dự định không

### Learning Goals

- [ ]  Nghiên cứu kỹ về cấu hình Kinesis Firehose, đặc biệt là Source (Direct Put), Destination (OpenSearch), và Data Transformation (Lambda function).
- [ ]  Đọc tài liệu về các IAM permissions cần thiết cho Kinesis Firehose để gửi dữ liệu đến OpenSearch và S3.
- [ ]  Tìm hiểu cách tạo index pattern trong OpenSearch Dashboard để xem dữ liệu được ingested từ Firehose.

### Meetings & Deadlines

- [ ]  Hoàn thành project trước ngày 20/07

## 📊 Self Assessment

### Productivity

- **Score**: [8/10]
- **Reason**: Mặc dù chỉ làm việc nửa ngày, đã giải quyết được một vấn đề lớn và quan trọng, giúp mở khóa các công việc tiếp theo.
- **Improvement**: Nếu có thể, nên dành trọn vẹn một ngày để có thể đạt được nhiều mục tiêu hơn.

### Learning

- **Score**: [9/10]
- **New Knowledge**: Kiến thức sâu sắc về bảo mật OpenSearch, đặc biệt là Fine-grained access control.
- **Application**: Áp dụng thành công các kỹ thuật debugging và cấu hình phức tạp.

### Overall Satisfaction

- **Score**: [8/10]
- **Highlights**: Vượt qua thử thách lớn nhất trong tuần, cảm thấy tự tin hơn với kiến thức về AWS Security.
- **Areas for Growth**: Tiếp tục phát triển kỹ năng tự học và giải quyết vấn đề, đồng thời cải thiện khả năng ước lượng thời gian cho các nhiệm vụ phức tạp.

## 📎 Attachments & Links

### Code & Projects

- [Notion](https://www.notion.so/Workshop-223c3d0326c8809e8078e153862ef46d?pvs=21)

---

**📝 Notes for tomorrow:**
[Ghi chú quan trọng cho ngày mai]

**🎯 Week Progress:** Day 3/5 completed.

---

*Worklog created by: Trương Đình Vũ Khanh*

*Next review: 17/07/2025*